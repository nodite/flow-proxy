# Flow Proxy Plugin 部署运维指南

## 目录

- [部署方式](#部署方式)
- [环境配置](#环境配置)
- [系统服务](#系统服务)
- [Docker 部署](#docker-部署)
- [监控告警](#监控告警)
- [日志管理](#日志管理)
- [性能调优](#性能调优)
- [故障排除](#故障排除)
- [维护升级](#维护升级)

---

## 部署方式

### 方式 1: 手动部署（开发/测试）

适用于开发、测试和小规模部署。

**步骤:**

1. 安装依赖
   ```bash
   poetry install
   ```

2. 配置环境
   ```bash
   cp .env.example .env
   # 编辑 .env 文件
   ```

3. 设置配置文件
   ```bash
   cp secrets.json.template secrets.json
   chmod 600 secrets.json
   # 编辑 secrets.json
   ```

4. 启动服务
   ```bash
   poetry run flow-proxy
   ```

**优点**: 简单快速
**缺点**: 无自动重启，需手动管理

### 方式 2: Systemd 服务（生产 Linux）

适用于生产 Linux 服务器，支持自动重启和系统集成。

**步骤:**

1. 创建服务用户
   ```bash
   sudo useradd -r -s /bin/false flow-proxy
   ```

2. 安装应用
   ```bash
   sudo mkdir -p /opt/flow-proxy-plugin
   sudo cp -r . /opt/flow-proxy-plugin/
   sudo chown -R flow-proxy:flow-proxy /opt/flow-proxy-plugin
   ```

3. 设置配置
   ```bash
   sudo mkdir -p /etc/flow-proxy
   sudo cp secrets.json /etc/flow-proxy/
   sudo chmod 600 /etc/flow-proxy/secrets.json
   sudo chown flow-proxy:flow-proxy /etc/flow-proxy/secrets.json
   ```

4. 创建环境文件
   ```bash
   sudo tee /etc/flow-proxy/flow-proxy.env << EOF
   FLOW_PROXY_PORT=8899
   FLOW_PROXY_HOST=127.0.0.1
   FLOW_PROXY_LOG_LEVEL=WARNING
   FLOW_PROXY_SECRETS_FILE=/etc/flow-proxy/secrets.json
   FLOW_PROXY_LOG_FILE=/var/log/flow-proxy/app.log
   EOF
   ```

5. 创建 systemd 服务文件
   ```bash
   sudo tee /etc/systemd/system/flow-proxy-plugin.service << EOF
   [Unit]
   Description=Flow Proxy Plugin
   After=network.target

   [Service]
   Type=simple
   User=flow-proxy
   Group=flow-proxy
   WorkingDirectory=/opt/flow-proxy-plugin
   EnvironmentFile=/etc/flow-proxy/flow-proxy.env
   ExecStart=/opt/flow-proxy-plugin/.venv/bin/python -m flow_proxy_plugin.cli
   Restart=always
   RestartSec=10

   [Install]
   WantedBy=multi-user.target
   EOF
   ```

6. 启动服务
   ```bash
   sudo systemctl daemon-reload
   sudo systemctl enable flow-proxy-plugin
   sudo systemctl start flow-proxy-plugin
   ```

7. 检查状态
   ```bash
   sudo systemctl status flow-proxy-plugin
   sudo journalctl -u flow-proxy-plugin -f
   ```

**优点**: 自动重启、系统集成、日志管理
**缺点**: 需要 root 权限，Linux 专用

### 方式 3: Docker 容器

适用于容器化环境、Kubernetes、云部署。

**创建 Dockerfile:**

```dockerfile
FROM python:3.10-slim

# 安装 Poetry
RUN pip install poetry

# 设置工作目录
WORKDIR /app

# 复制项目文件
COPY pyproject.toml poetry.lock ./
COPY flow_proxy_plugin ./flow_proxy_plugin

# 安装依赖
RUN poetry config virtualenvs.create false \
    && poetry install --no-dev --no-interaction --no-ansi

# 创建非 root 用户
RUN useradd -m -u 1000 flow-proxy && \
    chown -R flow-proxy:flow-proxy /app

USER flow-proxy

# 暴露端口
EXPOSE 8899

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8899/ || exit 1

# 启动命令
CMD ["poetry", "run", "flow-proxy"]
```

**构建和运行:**

```bash
# 构建镜像
docker build -t flow-proxy-plugin:latest .

# 运行容器
docker run -d \
    --name flow-proxy \
    -p 8899:8899 \
    -v $(pwd)/secrets.json:/app/secrets.json:ro \
    -e FLOW_PROXY_LOG_LEVEL=INFO \
    flow-proxy-plugin:latest
```

**Docker Compose:**

```yaml
version: "3.8"

services:
  flow-proxy:
    build: .
    container_name: flow-proxy-plugin
    ports:
      - "8899:8899"
    volumes:
      - ./secrets.json:/app/secrets.json:ro
      - ./logs:/app/logs
    environment:
      - FLOW_PROXY_PORT=8899
      - FLOW_PROXY_HOST=0.0.0.0
      - FLOW_PROXY_LOG_LEVEL=INFO
      - FLOW_PROXY_SECRETS_FILE=/app/secrets.json
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8899/"]
      interval: 30s
      timeout: 3s
      retries: 3
```

启动：

```bash
docker-compose up -d
```

**优点**: 可移植、隔离、易扩展
**缺点**: 需要 Docker 知识，额外开销

---

## 环境配置

### 开发环境

```bash
# .env.development
FLOW_PROXY_PORT=9000
FLOW_PROXY_HOST=127.0.0.1
FLOW_PROXY_LOG_LEVEL=DEBUG
FLOW_PROXY_SECRETS_FILE=secrets.dev.json
```

**特点**:
- Debug 日志
- 仅本地访问
- 开发凭据
- 单配置

### 测试环境

```bash
# .env.staging
FLOW_PROXY_PORT=8899
FLOW_PROXY_HOST=0.0.0.0
FLOW_PROXY_LOG_LEVEL=INFO
FLOW_PROXY_SECRETS_FILE=/etc/flow-proxy/secrets.staging.json
```

**特点**:
- Info 日志
- 网络可访问
- 测试凭据
- 多配置测试负载均衡

### 生产环境

```bash
# .env.production
FLOW_PROXY_PORT=8899
FLOW_PROXY_HOST=0.0.0.0
FLOW_PROXY_LOG_LEVEL=WARNING
FLOW_PROXY_SECRETS_FILE=/etc/flow-proxy/secrets.json
FLOW_PROXY_LOG_FILE=/var/log/flow-proxy/app.log
```

**特点**:
- Warning/Error 日志
- 网络可访问
- 生产凭据
- 多配置高可用
- 严格文件权限
- 监控告警

---

## 系统服务

### 服务管理命令

```bash
# 启动服务
sudo systemctl start flow-proxy-plugin

# 停止服务
sudo systemctl stop flow-proxy-plugin

# 重启服务
sudo systemctl restart flow-proxy-plugin

# 查看状态
sudo systemctl status flow-proxy-plugin

# 查看日志
sudo journalctl -u flow-proxy-plugin -f

# 查看最近 100 行日志
sudo journalctl -u flow-proxy-plugin -n 100

# 启用开机自启
sudo systemctl enable flow-proxy-plugin

# 禁用开机自启
sudo systemctl disable flow-proxy-plugin
```

### 服务配置优化

编辑 `/etc/systemd/system/flow-proxy-plugin.service`:

```ini
[Unit]
Description=Flow Proxy Plugin
After=network.target
Wants=network-online.target

[Service]
Type=simple
User=flow-proxy
Group=flow-proxy
WorkingDirectory=/opt/flow-proxy-plugin
EnvironmentFile=/etc/flow-proxy/flow-proxy.env

# 启动命令
ExecStart=/opt/flow-proxy-plugin/.venv/bin/python -m flow_proxy_plugin.cli

# 重启策略
Restart=always
RestartSec=10
StartLimitInterval=60
StartLimitBurst=3

# 资源限制
LimitNOFILE=65536
MemoryLimit=1G

# 安全加固
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/var/log/flow-proxy

[Install]
WantedBy=multi-user.target
```

应用更改：

```bash
sudo systemctl daemon-reload
sudo systemctl restart flow-proxy-plugin
```

---

## Docker 部署

### 单容器部署

```bash
# 构建镜像
docker build -t flow-proxy-plugin:1.0.0 .

# 运行容器
docker run -d \
    --name flow-proxy \
    --restart unless-stopped \
    -p 8899:8899 \
    -v $(pwd)/secrets.json:/app/secrets.json:ro \
    -v $(pwd)/logs:/app/logs \
    -e FLOW_PROXY_LOG_LEVEL=INFO \
    flow-proxy-plugin:1.0.0

# 查看日志
docker logs -f flow-proxy

# 查看状态
docker ps | grep flow-proxy

# 停止容器
docker stop flow-proxy

# 删除容器
docker rm flow-proxy
```

### Docker Compose 部署

创建 `docker-compose.yml`:

```yaml
version: "3.8"

services:
  flow-proxy:
    build:
      context: .
      dockerfile: Dockerfile
    image: flow-proxy-plugin:latest
    container_name: flow-proxy-plugin
    ports:
      - "8899:8899"
    volumes:
      - ./secrets.json:/app/secrets.json:ro
      - ./logs:/app/logs
    environment:
      FLOW_PROXY_PORT: 8899
      FLOW_PROXY_HOST: 0.0.0.0
      FLOW_PROXY_LOG_LEVEL: INFO
      FLOW_PROXY_SECRETS_FILE: /app/secrets.json
      FLOW_PROXY_LOG_FILE: /app/logs/app.log
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8899/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - flow-proxy-network

networks:
  flow-proxy-network:
    driver: bridge
```

管理命令：

```bash
# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 查看状态
docker-compose ps

# 停止服务
docker-compose down

# 重启服务
docker-compose restart

# 更新服务
docker-compose pull
docker-compose up -d
```

### Kubernetes 部署

创建 `k8s-deployment.yaml`:

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: flow-proxy-config
data:
  FLOW_PROXY_PORT: "8899"
  FLOW_PROXY_HOST: "0.0.0.0"
  FLOW_PROXY_LOG_LEVEL: "INFO"
---
apiVersion: v1
kind: Secret
metadata:
  name: flow-proxy-secrets
type: Opaque
stringData:
  secrets.json: |
    [
      {
        "name": "config1",
        "clientId": "your-client-id",
        "clientSecret": "your-client-secret",
        "tenant": "your-tenant"
      }
    ]
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: flow-proxy-plugin
spec:
  replicas: 3
  selector:
    matchLabels:
      app: flow-proxy-plugin
  template:
    metadata:
      labels:
        app: flow-proxy-plugin
    spec:
      containers:
      - name: flow-proxy
        image: flow-proxy-plugin:latest
        ports:
        - containerPort: 8899
        envFrom:
        - configMapRef:
            name: flow-proxy-config
        volumeMounts:
        - name: secrets
          mountPath: /app/secrets.json
          subPath: secrets.json
          readOnly: true
        livenessProbe:
          httpGet:
            path: /
            port: 8899
          initialDelaySeconds: 10
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /
            port: 8899
          initialDelaySeconds: 5
          periodSeconds: 10
      volumes:
      - name: secrets
        secret:
          secretName: flow-proxy-secrets
---
apiVersion: v1
kind: Service
metadata:
  name: flow-proxy-service
spec:
  selector:
    app: flow-proxy-plugin
  ports:
  - protocol: TCP
    port: 8899
    targetPort: 8899
  type: LoadBalancer
```

部署：

```bash
kubectl apply -f k8s-deployment.yaml
kubectl get pods
kubectl logs -f <pod-name>
```

---

## 监控告警

### 日志监控

**实时监控脚本** (`monitor.sh`):

```bash
#!/bin/bash

LOG_FILE="flow_proxy_plugin.log"
ALERT_EMAIL="admin@example.com"
ERROR_THRESHOLD=100
FAILED_CONFIG_THRESHOLD=1

# 检查错误率
error_count=$(grep -c ERROR "$LOG_FILE")
if [ $error_count -gt $ERROR_THRESHOLD ]; then
    echo "高错误率: $error_count 个错误" | \
        mail -s "Flow Proxy 告警" "$ALERT_EMAIL"
fi

# 检查配置失败
failed_configs=$(grep -c "marked as failed" "$LOG_FILE")
if [ $failed_configs -gt $FAILED_CONFIG_THRESHOLD ]; then
    echo "检测到失败的配置: $failed_configs" | \
        mail -s "Flow Proxy 告警" "$ALERT_EMAIL"
fi

# 检查日志文件大小
log_size=$(du -m "$LOG_FILE" | cut -f1)
if [ $log_size -gt 1000 ]; then
    echo "日志文件超过 1GB: ${log_size}MB" | \
        mail -s "Flow Proxy 告警" "$ALERT_EMAIL"
fi
```

设置定时任务：

```bash
# 每小时运行一次
crontab -e
0 * * * * /path/to/monitor.sh
```

### 性能监控

**监控指标:**

1. **请求成功率**
   ```bash
   total=$(grep "Request processed" flow_proxy_plugin.log | wc -l)
   success=$(grep "successfully" flow_proxy_plugin.log | wc -l)
   echo "成功率: $(($success * 100 / $total))%"
   ```

2. **配置使用分布**
   ```bash
   grep "Using configuration" flow_proxy_plugin.log | \
     awk -F"'" '{print $2}' | sort | uniq -c
   ```

3. **错误率**
   ```bash
   errors=$(grep ERROR flow_proxy_plugin.log | wc -l)
   total=$(wc -l < flow_proxy_plugin.log)
   echo "错误率: $(($errors * 100 / $total))%"
   ```

### 健康检查

**HTTP 健康检查端点:**

```bash
# 简单检查
curl -f http://localhost:8899/ || echo "服务不可用"

# 详细检查
curl -s http://localhost:8899/health | jq .
```

---

## 日志管理

### 日志轮转

使用 logrotate 管理日志文件。

创建 `/etc/logrotate.d/flow-proxy`:

```
/var/log/flow-proxy/*.log {
    daily                    # 每天轮转
    rotate 14                # 保留 14 天
    compress                 # 压缩旧日志
    delaycompress            # 延迟压缩
    notifempty               # 空文件不轮转
    create 0640 flow-proxy flow-proxy
    sharedscripts
    postrotate
        systemctl reload flow-proxy-plugin > /dev/null 2>&1 || true
    endscript
}
```

测试配置：

```bash
sudo logrotate -d /etc/logrotate.d/flow-proxy
```

手动轮转：

```bash
sudo logrotate -f /etc/logrotate.d/flow-proxy
```

### 集中日志

**使用 rsyslog 转发日志:**

编辑 `/etc/rsyslog.d/flow-proxy.conf`:

```
# 转发到中央日志服务器
*.* @@log-server.example.com:514
```

重启 rsyslog：

```bash
sudo systemctl restart rsyslog
```

---

## 性能调优

### 系统优化

**1. 文件描述符限制**

```bash
# 临时增加
ulimit -n 65536

# 永久增加（编辑 /etc/security/limits.conf）
flow-proxy soft nofile 65536
flow-proxy hard nofile 65536
```

**2. TCP 优化**

编辑 `/etc/sysctl.conf`:

```bash
# TCP 连接队列
net.core.somaxconn = 1024

# TCP 快速打开
net.ipv4.tcp_fastopen = 3

# 本地端口范围
net.ipv4.ip_local_port_range = 10000 65535
```

应用更改：

```bash
sudo sysctl -p
```

### 应用优化

**1. 日志级别**

生产环境使用 WARNING 或 ERROR：

```bash
export FLOW_PROXY_LOG_LEVEL=WARNING
```

**2. 配置数量**

- 小规模: 2-3 个配置
- 中等规模: 3-5 个配置
- 大规模: 5-10 个配置

**3. 使用 SSD**

将配置文件和日志放在 SSD 上以提高 I/O 性能。

---

## 故障排除

### 服务无法启动

**检查步骤:**

```bash
# 查看服务状态
sudo systemctl status flow-proxy-plugin

# 查看详细日志
sudo journalctl -u flow-proxy-plugin -n 100

# 检查配置文件
python3 -m json.tool /etc/flow-proxy/secrets.json

# 检查文件权限
ls -l /etc/flow-proxy/secrets.json

# 测试手动启动
sudo -u flow-proxy /opt/flow-proxy-plugin/.venv/bin/python -m flow_proxy_plugin.cli
```

### 高内存使用

**诊断:**

```bash
# 查看进程内存
ps aux | grep flow-proxy
top -p $(pgrep -f flow-proxy)
```

**解决:**

1. 降低日志级别
2. 实施日志轮转
3. 重启服务
4. 检查内存泄漏

### 响应慢

**诊断:**

```bash
# 测试响应时间
time curl http://localhost:8899/v1/models

# 压力测试
ab -n 100 -c 10 http://localhost:8899/v1/models
```

**解决:**

1. 检查网络延迟
2. 增加配置数量
3. 优化系统参数
4. 考虑使用缓存

---

## 维护升级

### 备份

**备份配置:**

```bash
# 备份 secrets.json
sudo cp /etc/flow-proxy/secrets.json \
    /backup/secrets.json.$(date +%Y%m%d)

# 备份环境配置
sudo cp /etc/flow-proxy/flow-proxy.env \
    /backup/flow-proxy.env.$(date +%Y%m%d)
```

### 升级流程

1. **备份当前版本**
   ```bash
   sudo cp -r /opt/flow-proxy-plugin \
       /opt/flow-proxy-plugin.backup
   ```

2. **停止服务**
   ```bash
   sudo systemctl stop flow-proxy-plugin
   ```

3. **更新代码**
   ```bash
   cd /opt/flow-proxy-plugin
   git pull
   poetry install
   ```

4. **测试配置**
   ```bash
   poetry run flow-proxy --help
   ```

5. **启动服务**
   ```bash
   sudo systemctl start flow-proxy-plugin
   ```

6. **验证**
   ```bash
   sudo systemctl status flow-proxy-plugin
   curl http://localhost:8899/v1/models
   ```

### 回滚

如果升级失败：

```bash
# 停止服务
sudo systemctl stop flow-proxy-plugin

# 恢复备份
sudo rm -rf /opt/flow-proxy-plugin
sudo mv /opt/flow-proxy-plugin.backup /opt/flow-proxy-plugin

# 启动服务
sudo systemctl start flow-proxy-plugin
```

---

**文档版本**: 1.0.0
**最后更新**: 2024-12-22
