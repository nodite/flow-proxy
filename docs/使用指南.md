# Flow Proxy Plugin 使用指南

## 目录

- [快速开始](#快速开始)
- [安装配置](#安装配置)
- [基本使用](#基本使用)
- [配置详解](#配置详解)
- [负载均衡](#负载均衡)
- [日志监控](#日志监控)
- [故障排除](#故障排除)
- [最佳实践](#最佳实践)

---

## 快速开始

### 5分钟快速上手

#### 1. 安装依赖

```bash
# 克隆项目
git clone <repository-url>
cd flow-proxy-plugin

# 安装 Poetry（如果未安装）
curl -sSL https://install.python-poetry.org | python3 -

# 安装项目依赖
poetry install
```

#### 2. 创建配置文件

```bash
# 从模板创建配置文件
cp secrets.json.template secrets.json

# 编辑配置文件，填入你的认证信息
# 至少需要配置 clientId, clientSecret, tenant
```

#### 3. 保护配置文件

```bash
chmod 600 secrets.json
```

#### 4. 启动服务

```bash
# 使用默认配置启动（端口 8899，仅本地访问）
poetry run flow-proxy

# 或使用自定义配置
poetry run flow-proxy --port 9000 --host 0.0.0.0 --log-level INFO
```

#### 5. 测试服务

```bash
# 测试 GET 请求
curl http://localhost:8899/v1/models

# 测试 POST 请求
curl -X POST http://localhost:8899/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{"model": "gpt-3.5-turbo", "messages": [{"role": "user", "content": "Hello"}]}'
```

---

## 安装配置

### 系统要求

- Python 3.8 或更高版本
- Poetry 1.2+ (依赖管理工具)
- 网络访问 Flow LLM Proxy 服务

### 详细安装步骤

#### 1. 安装 Poetry

**macOS/Linux:**
```bash
curl -sSL https://install.python-poetry.org | python3 -
```

**Windows (PowerShell):**
```powershell
(Invoke-WebRequest -Uri https://install.python-poetry.org -UseBasicParsing).Content | python -
```

**验证安装:**
```bash
poetry --version
```

#### 2. 安装项目依赖

```bash
# 安装所有依赖（包括开发依赖）
poetry install

# 仅安装生产依赖
poetry install --no-dev

# 激活虚拟环境
poetry shell
```

#### 3. 验证安装

```bash
poetry run flow-proxy --help
```

---

## 基本使用

### 启动方式

#### 方式 1: 使用默认配置

```bash
poetry run flow-proxy
```

默认配置：
- 端口: 8899
- 主机: 127.0.0.1 (仅本地访问)
- 日志级别: INFO
- 配置文件: secrets.json

#### 方式 2: 使用命令行参数

```bash
poetry run flow-proxy \
  --port 9000 \
  --host 0.0.0.0 \
  --log-level DEBUG \
  --secrets-file /path/to/secrets.json
```

#### 方式 3: 使用环境变量

```bash
export FLOW_PROXY_PORT=9000
export FLOW_PROXY_HOST=0.0.0.0
export FLOW_PROXY_LOG_LEVEL=DEBUG
poetry run flow-proxy
```

#### 方式 4: 使用 .env 文件

创建 `.env` 文件：

```bash
FLOW_PROXY_PORT=8899
FLOW_PROXY_HOST=127.0.0.1
FLOW_PROXY_LOG_LEVEL=INFO
FLOW_PROXY_SECRETS_FILE=secrets.json
FLOW_PROXY_LOG_FILE=flow_proxy_plugin.log
```

然后启动：

```bash
poetry run flow-proxy
```

### 命令行选项

| 选项 | 说明 | 默认值 | 环境变量 |
|------|------|--------|----------|
| `--port` | 监听端口 | 8899 | FLOW_PROXY_PORT |
| `--host` | 绑定主机地址 | 127.0.0.1 | FLOW_PROXY_HOST |
| `--log-level` | 日志级别 | INFO | FLOW_PROXY_LOG_LEVEL |
| `--secrets-file` | 配置文件路径 | secrets.json | FLOW_PROXY_SECRETS_FILE |
| `--log-file` | 日志文件路径 | flow_proxy_plugin.log | FLOW_PROXY_LOG_FILE |

### 停止服务

按 `Ctrl+C` 优雅地停止服务。

---

## 配置详解

### secrets.json 配置文件

#### 文件格式

secrets.json 必须是一个 JSON 数组，包含一个或多个认证配置：

```json
[
  {
    "name": "配置名称",
    "clientId": "客户端ID",
    "clientSecret": "客户端密钥",
    "tenant": "租户ID"
  }
]
```

#### 必需字段

这些字段用于生成 JWT 令牌，必须提供：

- **clientId** (string): Flow 认证的客户端标识符
- **clientSecret** (string): Flow 认证的客户端密钥
- **tenant** (string): Flow 认证的租户标识符

#### 可选字段

这些字段用于日志记录和配置管理：

- **name** (string): 配置的可读名称，在日志中显示
- **agent** (string): 代理标识符
- **appToAccess** (string): 应用程序标识符

#### 配置示例

**单配置（最小配置）:**

```json
[
  {
    "clientId": "your-client-id",
    "clientSecret": "your-client-secret",
    "tenant": "your-tenant"
  }
]
```

**多配置（负载均衡）:**

```json
[
  {
    "name": "primary-1",
    "clientId": "client-id-1",
    "clientSecret": "secret-1",
    "tenant": "production"
  },
  {
    "name": "primary-2",
    "clientId": "client-id-2",
    "clientSecret": "secret-2",
    "tenant": "production"
  },
  {
    "name": "backup",
    "clientId": "client-id-3",
    "clientSecret": "secret-3",
    "tenant": "production"
  }
]
```

**多租户配置:**

```json
[
  {
    "name": "tenant-a-primary",
    "clientId": "tenant-a-client",
    "clientSecret": "tenant-a-secret",
    "tenant": "tenant-a"
  },
  {
    "name": "tenant-b-primary",
    "clientId": "tenant-b-client",
    "clientSecret": "tenant-b-secret",
    "tenant": "tenant-b"
  }
]
```

### 环境变量配置

| 环境变量 | 说明 | 默认值 | 示例 |
|----------|------|--------|------|
| FLOW_PROXY_PORT | 监听端口 | 8899 | 9000 |
| FLOW_PROXY_HOST | 绑定地址 | 127.0.0.1 | 0.0.0.0 |
| FLOW_PROXY_LOG_LEVEL | 日志级别 | INFO | DEBUG, WARNING, ERROR |
| FLOW_PROXY_SECRETS_FILE | 配置文件路径 | secrets.json | /etc/flow-proxy/secrets.json |
| FLOW_PROXY_LOG_FILE | 日志文件路径 | flow_proxy_plugin.log | /var/log/flow-proxy.log |

### 不同环境的配置

**开发环境:**

```bash
FLOW_PROXY_PORT=9000
FLOW_PROXY_HOST=127.0.0.1
FLOW_PROXY_LOG_LEVEL=DEBUG
FLOW_PROXY_SECRETS_FILE=secrets.dev.json
```

**生产环境:**

```bash
FLOW_PROXY_PORT=8899
FLOW_PROXY_HOST=0.0.0.0
FLOW_PROXY_LOG_LEVEL=WARNING
FLOW_PROXY_SECRETS_FILE=/etc/flow-proxy/secrets.json
FLOW_PROXY_LOG_FILE=/var/log/flow-proxy/app.log
```

---

## 负载均衡

### Round-robin 策略

插件使用 Round-robin（轮询）策略在多个认证配置之间分配请求。

#### 工作原理

1. **顺序分配**: 请求按顺序使用不同的认证配置
2. **自动循环**: 到达最后一个配置后，自动从第一个开始
3. **故障处理**: 失败的配置自动跳过，使用下一个可用配置
4. **配置日志**: 每个请求都记录使用的配置名称

#### 配置示例

**基本负载均衡 (1:1):**

```json
[
  {"name": "config1", "clientId": "...", "clientSecret": "...", "tenant": "..."},
  {"name": "config2", "clientId": "...", "clientSecret": "...", "tenant": "..."}
]
```

请求分配: config1 → config2 → config1 → config2 → ...

**加权负载均衡 (3:1):**

```json
[
  {"name": "primary-1", ...},
  {"name": "primary-2", ...},
  {"name": "primary-3", ...},
  {"name": "backup", ...}
]
```

请求分配: primary-1 → primary-2 → primary-3 → backup → primary-1 → ...
(primary 配置接收 75% 的请求，backup 接收 25%)

### 故障转移

当某个配置失败时：

1. 插件自动标记该配置为失败
2. 从可用配置列表中移除
3. 使用下一个可用配置重试
4. 记录详细的故障信息

**故障转移日志示例:**

```
2024-01-15 10:30:45 - ERROR - Token generation failed for config 'primary-1'
2024-01-15 10:30:45 - ERROR - Configuration 'primary-1' marked as failed. Remaining: 2/3
2024-01-15 10:30:45 - INFO - Failover successful - using config 'primary-2'
```

### 监控负载均衡

**查看配置使用情况:**

```bash
# 查看所有配置使用记录
grep "Using configuration" flow_proxy_plugin.log

# 统计每个配置的使用次数
grep "Using configuration" flow_proxy_plugin.log | \
  awk -F"'" '{print $2}' | sort | uniq -c
```

**查看失败配置:**

```bash
# 查看所有失败记录
grep "marked as failed" flow_proxy_plugin.log

# 统计失败次数
grep "marked as failed" flow_proxy_plugin.log | wc -l
```

---

## 日志监控

### 日志级别

- **DEBUG**: 详细的调试信息（开发环境）
- **INFO**: 一般操作信息（默认，测试环境）
- **WARNING**: 警告信息（生产环境推荐）
- **ERROR**: 仅错误信息（生产环境）

### 查看日志

**实时查看:**

```bash
tail -f flow_proxy_plugin.log
```

**查看错误:**

```bash
grep ERROR flow_proxy_plugin.log
```

**查看配置使用:**

```bash
grep "Using configuration" flow_proxy_plugin.log
```

### 日志内容

插件记录以下信息：

1. 启动和初始化
2. 配置加载和验证
3. 负载均衡决策
4. JWT 令牌生成
5. 请求转发操作
6. 错误和故障转移
7. 关闭事件

---

## 故障排除

### 常见问题

#### 问题 1: 插件无法启动

**症状**: 插件启动后立即退出

**排查步骤:**

1. 检查 secrets.json 是否存在
2. 验证 JSON 格式是否正确
3. 确认所有必需字段都存在
4. 检查文件权限

**解决方法:**

```bash
# 验证文件存在
ls -la secrets.json

# 验证 JSON 格式
python3 -m json.tool secrets.json

# 设置正确权限
chmod 600 secrets.json

# 查看详细日志
poetry run flow-proxy --log-level DEBUG
```

#### 问题 2: 认证失败

**症状**: 请求返回 401 或 403 错误

**解决方法:**

1. 验证 clientId、clientSecret 和 tenant 是否正确
2. 检查凭据是否过期
3. 测试网络连接到 Flow LLM Proxy

```bash
# 测试连接
curl -I https://flow.ciandt.com/flow-llm-proxy
```

#### 问题 3: 端口被占用

**症状**: 启动时提示端口已被使用

**解决方法:**

```bash
# 查看端口占用
lsof -i :8899

# 使用不同端口
poetry run flow-proxy --port 9000
```

#### 问题 4: 所有配置都失败

**症状**: 日志显示所有配置都被标记为失败

**解决方法:**

1. 检查所有配置的凭据
2. 验证网络连接
3. 重启插件重置状态
4. 添加更多备份配置

### 调试技巧

**启用详细日志:**

```bash
poetry run flow-proxy --log-level DEBUG
```

**查看网络流量:**

```bash
# 使用 tcpdump
sudo tcpdump -i any -n port 8899 -A
```

---

## 最佳实践

### 安全性

1. **保护配置文件**
   ```bash
   chmod 600 secrets.json
   ```

2. **不要提交敏感信息**
   - 将 secrets.json 添加到 .gitignore
   - 使用环境变量存储敏感信息

3. **定期轮换凭据**
   - 定期更新 clientId 和 clientSecret
   - 使用不同的凭据用于不同环境

4. **限制网络访问**
   - 生产环境使用防火墙规则
   - 仅允许必要的 IP 地址访问

### 性能优化

1. **使用适当的日志级别**
   - 开发: DEBUG
   - 测试: INFO
   - 生产: WARNING 或 ERROR

2. **配置多个认证配置**
   - 建议至少 3 个配置
   - 更多配置 = 更好的负载分配

3. **监控资源使用**
   - 定期检查内存和 CPU 使用
   - 实施日志轮转

### 高可用性

1. **多个认证配置**
   ```json
   [
     {"name": "primary-1", ...},
     {"name": "primary-2", ...},
     {"name": "backup", ...}
   ]
   ```

2. **监控和告警**
   - 监控失败的配置
   - 设置告警通知

3. **定期测试故障转移**
   - 测试配置失败场景
   - 验证自动故障转移

### 环境分离

为不同环境使用不同的配置：

**开发环境 (secrets.dev.json):**
```json
[
  {
    "name": "dev-config",
    "clientId": "dev-client-id",
    "clientSecret": "dev-client-secret",
    "tenant": "dev-tenant"
  }
]
```

**生产环境 (secrets.prod.json):**
```json
[
  {
    "name": "prod-primary-1",
    "clientId": "prod-client-id-1",
    "clientSecret": "prod-client-secret-1",
    "tenant": "production"
  },
  {
    "name": "prod-primary-2",
    "clientId": "prod-client-id-2",
    "clientSecret": "prod-client-secret-2",
    "tenant": "production"
  }
]
```

启动时指定配置文件：

```bash
# 开发环境
poetry run flow-proxy --secrets-file secrets.dev.json

# 生产环境
poetry run flow-proxy --secrets-file secrets.prod.json
```

---

## 常见问题解答

### Q: 可以使用单个配置吗？

A: 可以，但不推荐。单个配置意味着没有负载均衡和故障转移。建议至少使用 2-3 个配置。

### Q: 如何实现加权负载均衡？

A: 通过在 secrets.json 中重复配置来实现。例如，要实现 3:1 的权重，使用 3 个 primary 配置和 1 个 backup 配置。

### Q: JWT 令牌会过期吗？

A: 当前实现的 JWT 令牌不包含过期时间。如果需要令牌过期功能，需要在 JWT 载荷中添加 exp 字段。

### Q: 插件支持哪些 HTTP 方法？

A: 插件支持所有标准 HTTP 方法：GET、POST、PUT、DELETE、OPTIONS 等。

### Q: 插件是否支持流式响应？

A: 是的，插件完全支持流式响应。响应数据会透明地传递给客户端。

### Q: 如何在多个环境中使用不同的配置？

A: 为每个环境创建单独的配置文件（如 secrets.dev.json、secrets.prod.json），然后使用 `--secrets-file` 参数指定。

---

**文档版本**: 1.0.0
**最后更新**: 2024-12-22
